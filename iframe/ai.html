<!doctype html>
<html lang="zh">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AI-HELP</title>
		<style>
			body {
				margin: 0;
				padding: 0;
				height: 100vh;
				overflow: hidden;
			}

			.container {
				width: 100%;
				height: 100vh;
				padding: 10px;
				box-sizing: border-box;
			}

			.chat-box {
				height: 300px;
				overflow-y: auto;
				border: 1px solid #ddd;
				padding: 16px;
				background: #f9fafb;
				border-radius: 8px;
			}

			.input-container {
				display: flex;
				gap: 8px;
				margin-top: 8px;
			}

			.input-field {
				flex: 1;
				padding: 8px;
				border-radius: 8px;
				border: 1px solid #ddd;
			}

			#imageInput {
				flex: 0 0 auto;
				width: 120px;
			}

			.button {
				width: 100%;
				padding: 8px;
				border-radius: 8px;
				border: 1px solid #ddd;
				margin-top: 8px;
			}

			.button {
				background-color: #3b82f6;
				color: white;
				border: none;
				cursor: pointer;
			}

			.button:hover {
				background-color: #2563eb;
			}

			.settings-modal {
				display: none;
				position: fixed;
				inset: 0;
				background: rgba(0, 0, 0, 0.5);
				align-items: center;
				justify-content: center;
			}

			.modal-content {
				background: white;
				padding: 24px;
				border-radius: 8px;
				width: 320px;
			}

			/* Markdown 样式优化 */
			.markdown-output pre {
				background: #282c34;
				color: #abb2bf;
				padding: 8px;
				border-radius: 4px;
				overflow-x: auto;
			}

			.markdown-output code {
				background: #f4f4f4;
				padding: 2px 4px;
				border-radius: 4px;
			}

			/* 用户消息气泡样式 */
			.user-message {
				padding: 8px;
				background: #dbeafe;
				color: #1e3a8a;
				border-radius: 8px;
				margin-top: 8px;
			}

			/* AI消息气泡样式 */
			.ai-message {
				padding: 8px;
				background: #e5e7eb;
				color: #1f2937;
				border-radius: 8px;
				margin-top: 8px;
			}

			/* 深色模式 */
			@media (prefers-color-scheme: dark) {
				body {
					color: #e0e0e0;
				}

				h2 {
					color: #4db8ff;
				}

				.chat-box {
					background: #2d2d2d;
					border: 1px solid #555;
					color: #e0e0e0;
				}

				.input-field {
					background-color: #3a3a3a;
					color: #e0e0e0;
					border: 1px solid #555;
				}

				.input-field::placeholder {
					color: #888;
				}

				.button {
					background-color: #0d6efd;
				}

				.button:hover {
					background-color: #0a58ca;
				}

				.modal-content {
					background: #2d2d2d;
					color: #e0e0e0;
				}

				.modal-content label {
					color: #4db8ff;
				}

				.markdown-output pre {
					background: #1a1a1a;
					color: #e0e0e0;
				}

				.markdown-output code {
					background: #3a3a3a;
					color: #e0e0e0;
				}

				/* 深色模式下的用户消息气泡 */
				.user-message {
					background: #1e3a8a;
					color: #bfdbfe;
				}

				/* 深色模式下的AI消息气泡 */
				.ai-message {
					background: #374151;
					color: #e5e7eb;
				}
			}
		</style>
		<script src="marked.min.js"></script>
	</head>

	<body>
		<div class="container">
			<h2>AI-HELP智能助手</h2>
			<div id="chat-box" class="chat-box"></div>
			<div class="input-container">
				<input type="text" id="message" placeholder="输入你的消息..." class="input-field" />
				<input type="file" id="imageInput" accept="image/*" class="input-field" />
			</div>
			<button onclick="sendMessage()" class="button">发送</button>
			<button onclick="toggleSettings()" class="button" style="background: gray">设置</button>
		</div>

		<!-- 设置界面 -->
		<div id="settingsModal" class="settings-modal">
			<div class="modal-content">
				<h3>设置</h3>
				<label>Ollama API 地址</label>
				<input type="text" id="ollamaUrl" value="http://localhost:11434/api/generate" class="input-field" />
				<label>模型名称（推荐minicpm-v）</label>
				<input type="text" id="modelInput" placeholder="请输入模型名称" class="input-field" />
				<button onclick="saveSettings()" class="button">保存</button>
				<button onclick="toggleSettings()" class="button" style="background: gray">关闭</button>
			</div>
		</div>

		<script>
			let pastedImage = null;

			document.addEventListener('paste', async (event) => {
				const items = event.clipboardData.items;
				for (const item of items) {
					if (item.type.startsWith('image')) {
						const file = item.getAsFile();
						const reader = new FileReader();
						reader.readAsDataURL(file);
						reader.onload = () => {
							pastedImage = reader.result;
							displayImage(pastedImage);
						};
					}
				}
			});

			document.getElementById('imageInput').addEventListener('change', (event) => {
				const file = event.target.files[0];
				if (file) {
					const reader = new FileReader();
					reader.readAsDataURL(file);
					reader.onload = () => {
						pastedImage = reader.result;
						displayImage(pastedImage);
					};
				}
			});

			function displayImage(base64Image) {
				const chatBox = document.getElementById('chat-box');
				const imgElement = document.createElement('img');
				imgElement.src = base64Image;
				imgElement.style.maxWidth = '100%';
				imgElement.style.borderRadius = '8px';
				imgElement.style.marginTop = '8px';
				chatBox.appendChild(imgElement);
				chatBox.scrollTop = chatBox.scrollHeight;
			}

			document.getElementById('message').addEventListener('keydown', function (event) {
				if (event.key === 'Enter') {
					event.preventDefault();
					sendMessage();
				}
			});

			async function sendMessage() {
				const messageInput = document.getElementById('message');
				const chatBox = document.getElementById('chat-box');
				const ollamaUrl = localStorage.getItem('ollamaUrl') || 'http://localhost:11434/api/generate';
				const model = localStorage.getItem('model');

				if (!model) {
					alert('请先设置模型名称');
					return;
				}

				const message = messageInput.value;
				chatBox.innerHTML += `<div class='user-message'>你: ${message}</div>`;
				chatBox.scrollTop = chatBox.scrollHeight;

				const requestBody = { model: model, prompt: message, stream: false };
				if (pastedImage) {
					requestBody.images = [pastedImage.split(',')[1]];
					pastedImage = null; // 发送后清除图片
				}

				messageInput.value = '';
				document.getElementById('imageInput').value = '';

				try {
					const response = await fetch(ollamaUrl, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(requestBody),
					});

					const jsonData = await response.json();
					if (jsonData.response) {
						const aiResponse = jsonData.response;
						const aiMessageDiv = document.createElement('div');
						aiMessageDiv.classList.add('markdown-output', 'ai-message');
						aiMessageDiv.innerHTML = marked.parse(aiResponse);
						chatBox.appendChild(aiMessageDiv);
						chatBox.scrollTop = chatBox.scrollHeight;
					}
				} catch (error) {
					console.error('请求失败:', error);
				}
			}

			// 切换设置界面显示/隐藏
			function toggleSettings() {
				const modal = document.getElementById('settingsModal');
				modal.style.display = modal.style.display === 'none' || modal.style.display === '' ? 'flex' : 'none';
			}

			// 保存设置
			function saveSettings() {
				localStorage.setItem('ollamaUrl', document.getElementById('ollamaUrl').value);
				localStorage.setItem('model', document.getElementById('modelInput').value);
				toggleSettings();
			}
		</script>
	</body>
</html>
